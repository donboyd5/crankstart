---
title: "Payments by the City and County of San Francisco to Nonprofit Organizations"
author: "Don Boyd, Boyd Research LLC"
date: today
date-format: long
editor: visual
---

\pagebreak

## Highlights

-   The City of San Francisco spent approximately \$933 million on grants to nonprofit organizations in its 2020-21 fiscal year, according to data from the city controller.

-   The top five departments accounted for 89 percent of grants to nonprofits. Three of these departments accounted for more than \$100 million each: Human Services (\$347 million), Homelessness Services (\$271 million), and Children, Youth and Their Families (\$110 million).

-   The top five nonprofit entities receiving grant payments accounted for 30.8 percent of grants.

-   The top three nonprofit recipients of city funds were:

    -   The [Children's Council of San Francisco](https://www.childrenscouncil.org/), which focuses on supporting child care and early childhood education, received \$85 million, or 9.1 percent of the total -- the most of any nonprofit agency.

    -   The [San Francisco In-Home Supportive Services (IHSS) Public Authority](https://www.sfihsspa.org/), a quasi-governmental public agency established by San Francisco ordinance that provides and promotes consumer-directed in-home support, received the next most, at \$75 million (8.1 percent).

    -   [Episcopal Community Services of San Francisco](https://ecs-sf.org/), which provides support to homeless and very low-income people, received \$48 million (5.2 percent).

-   More than 540 additional nonprofit organizations received city funds.

-   The city controller's data provides very little information on the uses of these funds. However, individual city departments maintain additional information on the purposes of specific grant funds. The Department of Children, Youth and Their Families provided data on their grant funded programs. These data are included in an accompanying html file and spreadsheet to illustrate the kind of information that may be available from individual agencies.

## Introduction

Nonprofit organizations play an important role in delivering services and helping the needy in San Francisco. This report presents and analyzes information on the city's payments to nonprofit organizations for the 2020-21 city fiscal year, ending June 30, 2021.[^1]

[^1]: References to "city" mean the city and county of San Francisco.

The sections below:

-   Describe data on payments to nonprofits,

-   List the city departments with greatest payments to nonprofits,

-   List the nonprofit organizations that receive the greatest payments,

-   Present a cross-tabulation of payments to major nonprofit organizations by major city departments.

-   Present selected data provided by the Department of Children, Youth and Their Families (DCYF) from its internal systems, to illustrate the kinds of additional information that may be available from agency-by-agency requests.

::: {.content-hidden when-format="docx"}
An appendix provides tables on payments by all departments and nonprofit organizations, in a sortable format. That document also illustrates details from the internal DCYF agency system.
:::

An associated Excel file includes the summary tables from this report plus additional detailed tables.

<!-- ::: {.content-hidden when-format="html"} -->

<!-- Will not appear in HTML. -->

<!-- ::: -->

<!-- <div style="page-break-after: always;"></div> -->

## About the Data

The analysis is based primarily on data maintained centrally by the city controller on payments to external organizations. Payments data provide information on actual spending in a specific time period.

The city publishes its centrally maintained payments data through two main mechanisms. The [Open Book](https://openbook-report.sfgov.org/OBMiddleware/report.aspx) portal allows creation of user-friendly reports filtered to restrict the data to specific time periods, departments, and other subsets; it allows downloads of potentially large amounts of data but is not designed primarily for that purpose. The [Open Data](https://data.sfgov.org/) portal provides for bulk downloads of large data files and other information in computer-friendly formats. While the two publishing mechanisms draw on similar data, the data elements included and time periods covered may differ between *Open Book* and *Open Data*.[^2]

[^2]: I brought several such differences to the attention of staff maintaining these data systems and they are working to correct them and develop greater internal consistency. As of this writing, they have not updated their data online to reflect these changes.

The city publishes data on payments to external organizations in the [Vendor Payments file](https://data.sfgov.org/City-Management-and-Ethics/Vendor-Payments-Vouchers-/n9pm-xkyq) on *Open Data* and makes similar user-friendly data available through a [Supplier Payments report](https://openbook-report.sfgov.org/OBMiddleware/report.aspx?reportname=5) on *Open Book*. This is the primary source of data used in this report.

In addition to data that the city maintains centrally, individual agencies maintain more-detailed data that they use for planning and management purposes. It was not practical in this project to obtain idiosyncratic data sets on a department-by-department basis. However, the Department of Children, Youth and Their Families, which has significant contracts with nonprofit organizations, provided detailed information on the funding allocations they make to nonprofit organizations. The appendix presents this information to illustrate the kind of supplemental information that may be available from individual departments.

### Identifying payments by department

The controller's data are not always precise enough to identify departments with certainty.

Several city entities are structured so that most of the services are performed or arranged by an administrative department or office, and the work is overseen by a commission that typically is responsible for setting policy and for community engagement, among other responsibilities.

For some of these commission-department arrangements, the controller's data identifies whether a grant payment was made by the commission or the department. For example, the data include separate entries for the Department of Children, Youth and Their Families and for the Children & Families Commission (also known as First 5 San Francisco). In these cases, the tables below show separately the payments made by the commission and the department.

For other commission-department arrangements, the controller's data do not specify which entity made the payment. This is the case for the Status of Women, the Police, Recreation and Parks, and the Environment. In these cases, the tables below label payments as being made by the relevant department, as departments typically have larger budgets and deliver or arrange most of the relevant services.

Finally, the controller's data lists payments by the mayor's office but does not identify which sub-office or offices made or arrange those payments. Several entities in the mayor's office appear to be responsible for arranging or delivering services, including primarily the Office of Housing and Community Development, and potentially the Office on Disability, and the Office of Neighborhood Services. In the tables below, these payments are labeled as being made by the Mayor's Office. They are likely to be associated with the Office of Housing and Community Development because this is the largest group in the mayor's office by far, and because the recipient entities generally appear to be delivering housing-related services.

### Departmental budgets

A table below shows payments to nonprofit organizations as a percentage of departmental budgets, for departments with the largest such payments. The denominator used in this calculation is the all-funds original budget amount for each department for the 2020-21 city fiscal year, as shown in the [*Budget and Appropriation Ordinance*](https://sfcontroller.org/sites/default/files/Documents/Budget/AAO%20FY2021-22%20%26%20FY2022-23%20-%20B%26F%20PROPOSED%20-%20FINAL%20210714.pdf) *of the Budget and Appropriations Committee, City and County of San Francisco, as of July 15, 2021*.

### Nonprofit entities

A nonprofit entity [as the city defines it](https://sfgov.org/cmd/sites/default/files/FileCenter/Documents/9818-NPE%20Certification.pdf) in these data must be a 501(c)(3) organization or similar entity, and must have a primary place of business that is a fixed office in San Francisco.

This report focuses on grants to nonprofit organizations, rather than all payments to nonprofits.

```{r libraries}
#| include: false
source(here::here("r", "libraries.r"))

# options(gt.html_tag_check = FALSE)

```

```{r functions}

source(here::here("r", "functions.r"))

gtsave2 <- function(tab, fpath, zoom=2, expand=5, vwidth=992, vheight=744) {
  gtlist <- list()
  gtlist$tab <- tab
  gtlist$fpath <- fpath
  gtlist$zoom <- zoom
  gtlist$expand <- expand
  gtlist$vwidth <- vwidth
  gtlist$vheight <- vheight
  
  saveRDS(gtlist, "gtlist.rds")
  # print(gtlist)
  source("gtsave2.r")
}

```

```{r notes}
# https://sf.gov/resource/2020/budget-information-by-department
```

```{r }
# useful links (btw, what is a "markdown div" or html div??)
# https://stackoverflow.com/questions/50455704/full-width-markdown-tables
# https://levelup.gitconnected.com/use-columns-adjust-margins-and-do-more-in-markdown-with-these-simple-pandoc-commands-adb4c19f9f35

```

## City Departments with the Greatest Payments to Nonprofits

This section presents grant payments to nonprofit organizations by city department. A table at the end of the section describes what each department does, based on its own materials.

### Departmental grant payments as percent of all grants and as a percentage of departmental budgets

The following table lists the city departments with the greatest payments to nonprofit organizations in 2020-21. It shows these payments as a percentage of all nonprofit payments and as a percentage of departmental budgets.

```{r tab_topdepts}
#| include: true
#| rows.print: 20

deptsort <- readRDS(here::here("report", "data", "deptsort.rds"))

# define number depts and number nonprofits to include, before all other
ndepts <- 20

# create a topn data frame
topndepts <- deptsort %>%
  select(deptcode, longname, paid, orig_budget) %>%
  arrange(desc(paid)) %>%
  mutate(rank=ifelse(row_number() <= ndepts, row_number(), NA_real_),
         deptcode=ifelse(row_number() <= ndepts, deptcode, NA_character_),
         longname=ifelse(row_number() <= ndepts, longname, "All other")) %>%
  group_by(rank, deptcode, longname) %>%
  summarise(paid=sum(paid),
            orig_budget=first(orig_budget),
            .groups = "drop") %>%
  mutate(paidpct=paid / sum(paid),
         cumpct=cumsum(paidpct),
         budpct=paid / orig_budget)

tabsums <- topndepts %>%
  summarise(paid=sum(paid), paidpct=sum(paidpct)) %>%
  mutate(cumpct=paidpct, 
         deptcode=NA_character_,
         longname="Total")

tabdata <- bind_rows(topndepts, tabsums) %>%
  select(-orig_budget)
saveRDS(tabdata, here::here("report", "data", "topndepts.rds"))

tab <- tabdata %>%
  gt() %>%
  cols_hide(deptcode) %>%
  tab_header(
    title = paste0("Top ",  
                   label_comma(accuracy=1)(ndepts), 
                   " City Departments, Payments to Nonprofit Organizations in 2020-21"),
    subtitle = "Payments under grant contracts"
    ) %>%
  cols_label(rank="Rank",
             longname="Department" ,
             paid=("Payment (dollars)"),
             paidpct=html("Percent of all grant payments"),
             cumpct=html("Cumulative percent"),
             budpct=html("Payment as % of department budget")) %>%
  cols_align(
    align = c("left"),
    columns = longname) %>%
  fmt_number(
    columns=c(rank, paid),
    scale_by = 1,
    decimals=0
  ) %>%
  fmt_currency(
    rows=c(1, nrow(tabdata)),
    columns=c(paid),
    scale_by = 1,
    decimals=0
  ) %>%
  fmt_percent(
    columns = c(paidpct, cumpct, budpct),
    decimals = 1) %>%
  fmt_missing(columns = c(rank, deptcode, budpct), missing_text = "") %>%
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=is.even(1:nrow(tabdata))
      )
    )

gtsave2(tab, here::here("report", "images", paste0("tab_topdepts.png")), zoom=2, expand=5)
# tab

```

![](images/tab_topdepts.png){width="100%"}

### Department descriptions

It is not always obvious from a city department's name what the department actually does. The following table summarizes what each of the top departments above does; the summaries are quotes or paraphrases of information from department websites. Ar link to the source of information is given in parentheses. Some departments provide more informative descriptions of what they do than do others.

```{r tab_deptservices}
#| include: false
tabdata <- deptsort |> 
  filter(deptcode %in% topndepts$deptcode) |> 
  select(longname, description) |>
  arrange(longname)


tab <- tabdata %>%
  gt() %>%
  tab_header(
    title = "City Departments With Largest Payments to Nonprofit Organizations in 2020-21")  |> 
  cols_label(longname="Department",
             description="Description") %>%
  cols_align(
    align = c("left"),
    columns = c(longname, description)) %>%
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=is.even(1:nrow(tabdata))
      )
    ) %>%
  tab_footnote(
    footnote = "Description is either quoted, or paraphrased by the author, from department web pages.",
    locations = cells_column_labels(
      columns = description
    ))
# tab

gtsave2(tab, here::here("report", "images", paste0("tab_topdepts_describe.png")), zoom=2, expand=5)

```

![](images/tab_topdepts_describe.png){width="100%"}

## Nonprofit Organizations That Receive the Greatest Payments

The table below lists nonprofit organizations with the greatest payments from the city in 2020-21. The organization names are presented as they are listed in the data file; in some cases, they clearly have been abbreviated.

```{r tab_topnpes}
#| eval: true
#| include: true
#| rows.print: 20

npesort <- readRDS(here::here("report", "data", "npesort.rds"))

# define number depts and number nonprofits to include, before all other
nnpes <- 30

# create a topn data frame
topnpes <- npesort %>%
  select(supplier, paid) %>%
  arrange(desc(paid)) %>%
  mutate(rank=ifelse(row_number() <= nnpes, row_number(), NA_real_),
         supplier=ifelse(row_number() <= nnpes, supplier, "All other")) %>%
  group_by(rank, supplier) %>%
  summarise(paid=sum(paid), .groups = "drop") %>%
  mutate(paidpct=paid / sum(paid),
         cumpct=cumsum(paidpct))

tabsums <- topnpes %>%
  summarise(paid=sum(paid), paidpct=sum(paidpct)) %>%
  mutate(cumpct=paidpct, supplier="Total")

tabdata <- bind_rows(topnpes, tabsums)
saveRDS(tabdata, here::here("report", "data", "topnpes.rds"))

tab <- tabdata %>%
  gt() %>%
  tab_header(
    title = paste0("Top ",  
                   label_comma(accuracy=1)(nnpes),
                   " Nonprofit Organizations Receiving Payments in 2020-21"),
    subtitle = "Payments under grant contracts"
    ) %>%
  cols_label(rank="Rank",
             supplier="Nonprofit entity" ,
             paid=("Payment (dollars)"),
             paidpct=html("Percent of all grant payments"),
             cumpct=html("Cumulative percent")) %>%
  cols_align(
    align = c("left"),
    columns = supplier) %>%
  fmt_number(
    columns=c(rank, paid),
    scale_by = 1,
    decimals=0
  ) %>%
  fmt_currency(
    rows=c(1, nrow(tabdata)),
    columns=c(paid),
    scale_by = 1,
    decimals=0
  ) %>%
  fmt_percent(
    columns = c(paidpct, cumpct),
    decimals = 1) %>%
  fmt_missing(columns = c(rank), missing_text = "") %>%
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=is.even(1:nrow(tabdata))
      )
    )
# tab

gtsave2(tab, here::here("report", "images", paste0("tab_topnpes.png")),
         zoom=2, expand=5)

# f <- label_number(accuracy=.1)
# f(12.3216)
# label_number(accuracy=.1)(12.32)
# label_comma(accuracy=.1)(124567.32)
# quarto render --cache-refresh --to html
#  !(images/tab_topnpes.png)

```

![](images/tab_topnpes.png){width="100%"}

## NonProfit Organizations with the Largest Grant Payments, by Department

```{r tab_topnpe_bydept}
#| eval: true
#| include: true
# #| column: screen-inset-right
# #| column: screen  # page screen
#| rows.print: 40

npedeptsort <- readRDS(here::here("report", "data", "npedeptsort.rds"))

# define number depts and number nonprofits to include, before all other
ndepts <- 10
nnpes <- 30

# create a topn data frame
topnpesdepts <- npedeptsort %>%
  select(longname, supplier, paid, deptrank, nperank) %>%
  mutate(deptrank=ifelse(deptrank > ndepts, 1e9, deptrank),
         longname=ifelse(deptrank > ndepts, "All other", longname),
         nperank=ifelse(nperank > nnpes, 1e9, nperank),
         supplier=ifelse(nperank > nnpes, "All other", supplier)) %>%
  group_by(deptrank, longname, nperank, supplier) %>%
  summarise(paid=sum(paid), .groups = "drop")

deptsums <- topnpesdepts %>%
  group_by(longname) %>%
  summarise(paid=sum(paid, na.rm=TRUE), .groups="drop") %>%
  mutate(nperank=2e9, supplier="Total")

npesums <- topnpesdepts %>%
  group_by(nperank, supplier) %>%
  summarise(paid=sum(paid, na.rm=TRUE), .groups="drop") %>%
  mutate(longname="Total")

allsums <- deptsums %>%
  summarise(paid=sum(paid, na.rm=TRUE), .groups="drop") %>%
  mutate(nperank=2e9, supplier="Total", longname="Total")
  

tabdata_long <- bind_rows(topnpesdepts, deptsums, npesums, allsums)

tabdata <- tabdata_long %>%
  select(longname, nperank, supplier, paid) %>%
  pivot_wider(names_from = longname, values_from = paid) %>%
  arrange(nperank) %>%
  mutate(nperank=ifelse(nperank > nnpes, NA_real_, nperank))

saveRDS(tabdata, here::here("report", "data", "topnpesdepts.rds"))

tab <- tabdata %>%
  gt() %>%
  tab_header(
    title = paste0("Top ",  
                   label_comma(accuracy=1)(nnpes), 
                   " Nonprofit Organizations Receiving Payments in 2020-21, by Department"),
    subtitle = "Payments under grant contracts"
    ) %>%
  cols_label(nperank="Rank",
             supplier="Nonprofit entity") %>%
  cols_align(
    align = c("left"),
    columns = supplier) %>%
  fmt_number(
    columns=c(1, 3:ncol(tabdata)),
    scale_by = 1,
    decimals=0
  ) %>%
  fmt_currency(
    rows=c(1, nrow(tabdata)),
    columns=3:ncol(tabdata),
    scale_by = 1,
    decimals=0
  ) %>%
  fmt_missing(columns = everything(), missing_text = "--") %>%
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=is.even(1:nrow(tabdata))
      )
    )
# tab
# tab_html <- tab %>% 
#   as_raw_html()

# savetab(basename, .tab=tab, .tabdata=tabdata, zoom=2, expand=5)
# savetab("tab_topdepts")
gtsave2(tab, here::here("report", "images", paste0("tab_topnpe_bydept.png")),
         zoom=1, expand=5, vwidth=4000)

# f <- label_number(accuracy=.1)
# f(12.3216)
# label_number(accuracy=.1)(12.32)
# label_comma(accuracy=.1)(124567.32)
# quarto render --cache-refresh --to html
#  !(images/tab_topnpes.png)

# zoom=2, expand=5
# vwidth = 992,
# vheight = 744,

```

\blandscape

::: {.column height="200%" width="200%"}
![](images/tab_topnpe_bydept.png){height="100%" width="95%"}
:::

\elandscape

## Appendix

### All Nonprofit Organizations and All Departments

<!-- :::{style="width: 1400px; height:auto; margin: auto; font-size: 8pt;"} -->

<!-- ::: {style="width: 175%; height:auto; margin: auto; font-size: 8pt;"} -->

::: {style="width: 175%; font-size: 8pt;"}
```{r}
#| label: all_table
#| include: true
#| echo: false
# #| column: screen-right
# #| column: page
# #| column: screen
# #| column: screen-inset-right
# #| column: screen-right

tabdata <- readRDS(here::here("report", "data", "npedept_wide.rds"))

tab <- datatable(tabdata,
                 rownames=FALSE,
                 filter = "top", 
                 extensions = c("Buttons","FixedColumns"),
                 options=list(pageLength = 15, 
                              autoWidth = TRUE,
                              scrollX = TRUE,
                              fixedColumns = list(leftColumns = 2),
                              columnDefs = list(
                                list(width = '220px', targets = 1)))
                 ) %>% 
  formatCurrency(c(3:ncol(tabdata)), digits=0)

tab

```
:::

### Data for Department of Children, Youth and Their Families

The table below shows grant allocations for 2020-21 and 2021-22, by program, provided by the Department of Children, Youth and Their Familes. Grant allocations provide information on expected or planned spending, rather than actual spending, and thus will differ in amounts from numbers in other tables, which are based on actual spending.

::: {style="width: 175%; height:auto; margin: auto; font-size: 8pt;"}
```{r}
#| include: true
#| echo: false
# #| column: screen-inset-right
# #| column: screen-right

dcyf <- readRDS(here::here("report", "data", "dcyf_wide.rds"))

tab <- 
  datatable(dcyf,
            rownames=FALSE,
            colnames=c("service area" = 4),
            filter = "top", 
            extensions = c("Buttons","FixedColumns"),
            options=list(pageLength = 10, 
                         autoWidth = TRUE,
                         scrollX = TRUE,
                         columnDefs = list(
                           list(width = '75px', targets = c(0:4, 6:7))))
            ) %>% 
  formatCurrency(c(7:8), digits=0)

# ,                           list(width = '300px', targets = 6)

tab

```
:::

<!-- </div> -->
